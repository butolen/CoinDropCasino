@page "/game-history"
@using System.Security.Claims
@using CoinDrop.services.interfaces
@using Microsoft.AspNetCore.Components.Authorization
@using WebApp.services.dtos
@rendermode InteractiveServer

@inject IGameHistoryService GameHistoryService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

<div class="history-page">
    <div class="panel">
        <div class="panel-title">GAME HISTORY</div>

        <a class="transaction-history-btn" href="/history">TRANSACTION HISTORY</a>

        <div class="section-title">GAME SESSIONS</div>

        <div class="filters">
            <div class="field">
                <label>Game Type</label>
                <select @bind="_query.GameType">
                    <option value="@GameTypeFilter.All">All</option>
                    <option value="@GameTypeFilter.Blackjack">Blackjack</option>
                    <option value="@GameTypeFilter.Roulette">Roulette</option>
                </select>
            </div>

            <div class="field">
                <label>Result</label>
                <select @bind="_query.Result">
                    <option value="@GameResultFilter.All">All</option>
                    <option value="@GameResultFilter.Win">Win</option>
                    <option value="@GameResultFilter.Loss">Loss</option>
                    <option value="@GameResultFilter.Draw">Draw</option>
                </select>
            </div>

            

            <div class="field">
                <label>Min Bet Amount (EUR)</label>
                <input type="number"
                       step="0.01"
                       min="0"
                       @bind="_minBetAmount" />
            </div>

            <div class="field">
                <label>Min Win Amount (EUR)</label>
                <input type="number"
                       step="0.01"
                       min="0"
                       @bind="_minWinAmount" />
            </div>

            <div class="filter-actions">
                <button class="btn-primary" @onclick="ApplyFilters">Apply</button>
                <button class="btn-ghost" @onclick="ResetFilters">Reset</button>
            </div>
        </div>

        <div class="table-wrap">
            <table class="tx-table">
                <thead>
                    <tr>
                        <th>Game</th>
                        <th class="num">Bet Amount (EUR)</th>
                        <th>Result</th>
                        <th class="num">Win Amount (EUR)</th>
                        <th>Balance Before</th>
                        <th>Balance After</th>
                        <th>Timestamp (Local)</th>
                    </tr>
                </thead>
                <tbody>
                    @if (_loading)
                    {
                        <tr><td colspan="7" class="muted">Loading...</td></tr>
                    }
                    else if (_rows.Length == 0)
                    {
                        <tr><td colspan="7" class="muted">No game sessions found.</td></tr>
                    }
                    else
                    {
                        @foreach (var r in _rows)
                        {
                            <tr>
                                <td>@r.Game</td>
                                <td class="num">@FormatEur(r.BetAmount)</td>
                                <td class="@GetResultClass(r.Result)">@r.Result</td>
                                <td class="num @GetWinAmountClass(r.WinAmount)">@FormatEur(r.WinAmount)</td>
                                <td class="num">@FormatEur(r.BalanceBefore)</td>
                                <td class="num">@FormatEur(r.BalanceAfter)</td>
                                <td>@ToLocal(r.TimestampUtc).ToString("dd.MM.yyyy HH:mm")</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private bool _loading;
    private GameHistoryRowDto[] _rows = Array.Empty<GameHistoryRowDto>();

    private GameHistoryQuery _query = new()
    {
        GameType = GameTypeFilter.All,
        Result = GameResultFilter.All
    };

    private DateTime? _fromLocal;
    private DateTime? _toLocal;
    private double? _minBetAmount;
    private double? _minWinAmount;

    private readonly SemaphoreSlim _loadLock = new(1, 1);
    private bool _loadedOnce;

    protected override Task OnInitializedAsync()
    {
        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _loadedOnce) return;
        _loadedOnce = true;

        await LoadAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task ApplyFilters()
    {
        SyncFiltersIntoQuery();
        await LoadAsync();
    }

    private async Task ResetFilters()
    {
        _query = new GameHistoryQuery
        {
            GameType = GameTypeFilter.All,
            Result = GameResultFilter.All
        };

        _fromLocal = null;
        _toLocal = null;
        _minBetAmount = null;
        _minWinAmount = null;

        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        await _loadLock.WaitAsync();
        try
        {
            _loading = true;

            var userId = await GetCurrentUserIdAsync();
            if (userId <= 0)
            {
                _rows = Array.Empty<GameHistoryRowDto>();
                return;
            }

            var result = await GameHistoryService.GetForUserAsync(userId, _query);
            _rows = result.Items;
        }
        finally
        {
            _loading = false;
            _loadLock.Release();
        }
    }

    private void SyncFiltersIntoQuery()
    {
        _query.FromUtc = _fromLocal.HasValue ? LocalToUtc(_fromLocal.Value) : null;
        _query.ToUtc = _toLocal.HasValue ? LocalToUtc(_toLocal.Value) : null;
        _query.MinBetAmount = _minBetAmount.HasValue ? Math.Max(0, _minBetAmount.Value) : null;
        _query.MinWinAmount = _minWinAmount.HasValue ? Math.Max(0, _minWinAmount.Value) : null;
    }

    private static DateTime LocalToUtc(DateTime local)
        => DateTime.SpecifyKind(local, DateTimeKind.Local).ToUniversalTime();

    private static DateTime ToLocal(DateTime utc)
        => DateTime.SpecifyKind(utc, DateTimeKind.Utc).ToLocalTime();

    private static string FormatEur(double eur)
        => eur.ToString("0.00") + " â‚¬";

    private string GetResultClass(string result)
    {
        return result.ToLower() switch
        {
            "win" => "result-win",
            "loss" => "result-loss",
            "draw" => "result-draw",
            _ => ""
        };
    }

    private string GetWinAmountClass(double winAmount)
    {
        return winAmount > 0 ? "win-positive" : "";
    }

    private async Task<int> GetCurrentUserIdAsync()
    {
        try
        {
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = state.User;

            if (user?.Identity?.IsAuthenticated != true)
                return 0;

            var idStr =
                user.FindFirstValue(ClaimTypes.NameIdentifier)
                ?? user.FindFirstValue("sub")
                ?? user.FindFirstValue("userid");

            return int.TryParse(idStr, out var id) ? id : 0;
        }
        catch
        {
            return 0;
        }
    }
}