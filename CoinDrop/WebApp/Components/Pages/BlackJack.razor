@page "/blackjack"
@attribute [Authorize]

@using CoinDrop
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Authorization

@using CoinDrop.services.interfaces
@inject IBlackjackService BlackjackService
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<PageTitle>Blackjack</PageTitle>

<div class="blackjack-page">
    <!-- Debug Info -->
    <div class="debug-info">
        <div>hasActiveGame: @hasActiveGame</div>
        <div>Status: @currentGameStatus</div>
        <div>Cards: @playerCards.Count / @dealerCards.Count</div>
        <div>UserID: @currentUserId</div>
    </div>

    <!-- Dealer Animation -->
    @if (showDealerAnimation)
    {
        <div class="dealer-animation">
            <div class="animation-content">
                <div class="animation-text">Dealer draws cards...</div>
                <div class="card-animation">
                    @for (int i = 0; i < 3; i++)
                    {
                        <div class="animated-card" style="animation-delay: @(i * 0.2)s"></div>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Result Popup -->
    @if (showResultPopup)
    {
        <div class="result-popup-overlay">
            <div class="result-popup">
                <div class="result-title @resultClass">@resultMessage</div>
                
                @if (winAmount > 0)
                {
                    <div class="result-win-amount">+€ @winAmount.ToString("N2")</div>
                }
                
                <div class="result-details">
                    <div class="result-detail">
                        <div class="detail-label">New Balance</div>
                        <div class="detail-value">
                            € @(currentGameStatus == "Surrendered" 
                                  ? (userBalance - (currentGameBet / 2)).ToString("N2")
                                  : currentGameStatus == "Blackjack"
                                      ? (userBalance + (currentGameBet * 1.5)).ToString("N2")
                                      : winAmount > 0
                                          ? (userBalance + currentGameBet).ToString("N2") 
                                          : (userBalance - currentGameBet).ToString("N2"))
                        </div>
                    </div>
                </div>
                <button class="result-new-game-btn" @onclick="@(() => NavigationManager.NavigateTo("/blackjack", forceLoad:true))">
                    PLAY AGAIN
                </button>
            </div>
        </div>
    }

    <!-- Main Game Table -->
    <div class="casino-table">
        <!-- Error Message -->
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-message">
                <span>@errorMessage</span>
                <button class="close-error-btn" @onclick="ClearErrorMessage">×</button>
            </div>
        }

        <!-- Game Header -->
        <div class="game-header">
            <div class="balance-display">
                <div class="balance-label">BALANCE</div>
                <div class="balance-amount">€ @userBalance.ToString("N2")</div>
            </div>
            
            <div class="current-game-info">
                @if (hasActiveGame)
                {
                    <div class="bet-display">BET: € @currentGameBet.ToString("N2")</div>
                    <div class="game-status status-@currentGameStatus.ToLower()">
                        @currentGameStatus
                    </div>
                }
            </div>
            
            <div class="game-controls-header">
                <button class="rules-btn" @onclick="ToggleRules">
                    <span>ℹ️</span> RULES
                </button>
                <button class="new-game-btn" @onclick="NewGame">
                    <span>🔄</span> NEW GAME
                </button>
            </div>
        </div>

        <!-- Rules Popup -->
        @if (showRules)
        {
            <div class="bet-section">
                <h4 class="bet-title">BLACKJACK RULES</h4>
                <div style="text-align: left; color: #d4af37;">
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li>• Beat dealer without going over 21</li>
                        <li>• Ace = 1 or 11</li>
                        <li>• Blackjack (A+10) pays 3:2</li>
                        <li>• Dealer stands on 17</li>
                        <li>• Double Down: Double bet, 1 card</li>
                        <li>• Surrender: 50% back in first round</li>
                    </ul>
                </div>
            </div>
        }

        <!-- Game Area -->
        <div class="game-area">
            <!-- Dealer -->
            <div class="dealer-area">
                <h3 class="area-title">DEALER</h3>
                <div class="cards-container">
                    @if (dealerCards.Any())
                    {
                        @foreach (var card in dealerCards)
                        {
                            <div class="card-wrapper">
                                <img src="@card.ImagePath" 
                                     class="card-img" 
                                     onerror="this.src='/images/BJCards/card_back.png'" />
                                @if (card.Value > 0)
                                {
                                    <div class="card-value">@card.Value</div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <div class="card-wrapper">
                            <div class="card-img" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);"></div>
                        </div>
                        <div class="card-wrapper">
                            <div class="card-img" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);"></div>
                        </div>
                    }
                </div>
                @if (dealerValue > 0)
                {
                    <div class="hand-score">Value: @dealerValue</div>
                }
            </div>

            <!-- Player -->
            <div class="player-area">
                <h3 class="area-title">PLAYER</h3>
                
                <!-- Main Hand -->
                <div class="cards-container">
                    @if (playerCards.Any())
                    {
                        @foreach (var card in playerCards)
                        {
                            <div class="card-wrapper">
                                <img src="@card.ImagePath" 
                                     class="card-img" 
                                     onerror="this.src='/images/BJCards/card_back.png'" />
                                <div class="card-value">@card.Value</div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="card-wrapper">
                            <div class="card-img" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);"></div>
                        </div>
                        <div class="card-wrapper">
                            <div class="card-img" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);"></div>
                        </div>
                    }
                </div>
                @if (playerValue > 0)
                {
                    <div class="hand-score">Value: @playerValue</div>
                }
            </div>
        </div>

        <!-- Bet Selection -->
        @if (!hasActiveGame)
        {
            <div class="bet-section">
                <h4 class="bet-title">CHOOSE YOUR BET</h4>
                <div class="chips-row">
                    @foreach (var chip in availableChips)
                    {
                        <button class="chip-btn chip-@chip.Value @(selectedChip == chip.Value ? "selected" : "")"
                                @onclick="() => SelectChip(chip.Value)">
                            €@chip.Text
                        </button>
                    }
                </div>
                <button class="start-game-btn" @onclick="StartGame"
                        disabled="@(isStartingGame || userBalance < selectedChip)">
                    @if (isStartingGame)
                    {
                        <div class="spinner"></div>
                    }
                    else
                    {
                        <span>🎮 START GAME (€@selectedChip)</span>
                    }
                </button>
            </div>
        }

        <!-- Action Buttons -->
        @if (hasActiveGame && currentGameStatus == "Active")
        {
            <div class="action-buttons">
                <button class="action-btn hit" @onclick="Hit"
                        disabled="@(isProcessingAction)">
                    <span class="action-btn-icon">🃏</span>
                    HIT
                </button>

                <button class="action-btn stand" @onclick="Stand"
                        disabled="@(isProcessingAction)">
                    <span class="action-btn-icon">✋</span>
                    STAND
                </button>

                <button class="action-btn double" @onclick="DoubleDown"
                        disabled="@(!canDoubleDown || isProcessingAction || userBalance < currentGameBet)">
                    <span class="action-btn-icon">⏫</span>
                    DOUBLE
                </button>

                <button class="action-btn surrender" @onclick="Surrender"
                        disabled="@(playerCards.Count > 2 || isProcessingAction)">
                    <span class="action-btn-icon">🏳️</span>
                    SURRENDER
                </button>
            </div>
        }
    </div>
</div>

@code {
    // User Data
    private ApplicationUser? currentUser;
    private string currentUserId = "";
    private double userBalance;
    
    // Game State
    private bool hasActiveGame = false;
    private double currentGameBet = 0;
    private string currentGameStatus = "";
    private double winAmount = 0;
    
    // Cards Data
    private List<CardResponse> playerCards = new();
    private List<CardResponse> dealerCards = new();
    private int playerValue = 0;
    private int dealerValue = 0;
    
    // Game Options
    private bool canDoubleDown = false;
    
    // Bet Selection
    private double selectedChip = 1;
    private readonly List<(string Text, double Value)> availableChips = new()
    {
        ("1", 1), ("5", 5), ("10", 10), ("50", 50), ("100", 100)
    };
    
    // UI State
    private bool showRules = false;
    private bool showResultPopup = false;
    private string errorMessage = "";
    private string resultMessage = "";
    private string resultClass = "";
    private bool showDealerAnimation = false;
    
    // Processing State
    private bool isProcessingAction = false;
    private bool isStartingGame = false;
    private string currentAction = "";
    
    // Response Models
    private class CardResponse
    {
        public string ValueName { get; set; } = "";
        public string SuitName { get; set; } = "";
        public string ImagePath { get; set; } = "";
        public string ImageName { get; set; } = "";
        public int Value { get; set; }
        public bool IsAce { get; set; }
        public bool IsFaceCard { get; set; }
    }
    
    protected override async Task OnInitializedAsync()
    {
        await LoadUserData();
        await LoadGameState();
    }
    
    private async Task RefreshUserBalance()
    {
        try
        {
            if (!string.IsNullOrEmpty(currentUserId))
            {
                currentUser = await UserManager.FindByIdAsync(currentUserId);
                if (currentUser != null)
                {
                    userBalance = currentUser.TotalBalance;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing balance: {ex.Message}");
        }
    }
    
    private async Task LoadUserData()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user.Identity?.IsAuthenticated == true)
            {
                currentUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "";
                
                if (!string.IsNullOrEmpty(currentUserId))
                {
                    currentUser = await UserManager.FindByIdAsync(currentUserId);
                    if (currentUser != null)
                    {
                        userBalance = currentUser.TotalBalance;
                        
                        await InvokeAsync(StateHasChanged);
                    }
                }
            }
            else
            {
                NavigationManager.NavigateTo("/login");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in LoadUserData: {ex.Message}");
        }
    }
    
    private async Task LoadGameState()
    {
        try
        {
            if (!string.IsNullOrEmpty(currentUserId) && int.TryParse(currentUserId, out int userId))
            {
                var response = await BlackjackService.GetGameStateAsync(userId);
                
                if (response.Success && response.Data != null)
                {
                    var json = JsonSerializer.Serialize(response.Data);
                    var jsonDoc = JsonDocument.Parse(json);
                    var root = jsonDoc.RootElement;
                    
                    if (root.TryGetProperty("HasActiveGame", out var hasActiveGameElement))
                    {
                        hasActiveGame = hasActiveGameElement.GetBoolean();
                    }
                    
                    if (hasActiveGame && root.TryGetProperty("Game", out var gameElement))
                    {
                        await UpdateGameData(gameElement);
                        showResultPopup = false;
                    }
                    else
                    {
                        ClearGameState();
                    }
                }
                else
                {
                    hasActiveGame = false;
                    ClearGameState();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in LoadGameState: {ex.Message}");
            errorMessage = "Error loading game state";
            hasActiveGame = false;
            ClearGameState();
        }
        
        await RefreshUserBalance();
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task UpdateGameData(object gameData)
    {
        try
        {
            var json = JsonSerializer.Serialize(gameData);
            var jsonDoc = JsonDocument.Parse(json);
            var root = jsonDoc.RootElement;
            
            if (root.TryGetProperty("BetAmount", out var betElement))
                currentGameBet = betElement.GetDouble();
            
            if (root.TryGetProperty("Status", out var statusElement))
                currentGameStatus = statusElement.GetString() ?? "";
            
            if (root.TryGetProperty("WinAmount", out var winElement))
                winAmount = winElement.GetDouble();
            
            // Player cards
            playerCards.Clear();
            if (root.TryGetProperty("PlayerHand", out var playerHandElement))
            {
                foreach (var cardElement in playerHandElement.EnumerateArray())
                {
                    playerCards.Add(ParseCard(cardElement));
                }
            }
            
            // Dealer cards
            dealerCards.Clear();
            if (root.TryGetProperty("DealerHand", out var dealerHandElement))
            {
                foreach (var cardElement in dealerHandElement.EnumerateArray())
                {
                    dealerCards.Add(ParseCard(cardElement));
                }
            }
            
            // Values
            if (root.TryGetProperty("PlayerValue", out var playerValueElement))
                playerValue = playerValueElement.GetInt32();
            
            if (root.TryGetProperty("DealerValue", out var dealerValueElement))
                dealerValue = dealerValueElement.GetInt32();
            
            // Options
            if (root.TryGetProperty("CanDoubleDown", out var canDoubleDownElement))
                canDoubleDown = canDoubleDownElement.GetBoolean();
            
            hasActiveGame = currentGameStatus == "Active";
            
            // 🔴 WICHTIG: Balance vor Popup aktualisieren
            await RefreshUserBalance();
            
            if (currentGameStatus != "Active" && !showResultPopup)
            {
                // 🔴 Extra Delay für DB-Update
                await Task.Delay(300);
                // 🔴 Balance ERNEUT laden für korrekte Anzeige
                await RefreshUserBalance();
                
                resultMessage = GetResultMessage(currentGameStatus);
                resultClass = GetResultClass(currentGameStatus);
                showResultPopup = true;
            }
            else
            {
                showResultPopup = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in UpdateGameData: {ex.Message}");
            errorMessage = "Error updating game data";
            ClearGameState();
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private CardResponse ParseCard(JsonElement cardElement)
    {
        return new CardResponse
        {
            ValueName = cardElement.TryGetProperty("ValueName", out var vn) ? vn.GetString() ?? "" : "",
            SuitName = cardElement.TryGetProperty("SuitName", out var sn) ? sn.GetString() ?? "" : "",
            ImagePath = cardElement.TryGetProperty("ImagePath", out var ip) ? ip.GetString() ?? "" : "",
            ImageName = cardElement.TryGetProperty("ImageName", out var inProp) ? inProp.GetString() ?? "" : "",
            Value = cardElement.TryGetProperty("Value", out var v) ? v.GetInt32() : 0,
            IsAce = cardElement.TryGetProperty("IsAce", out var ia) ? ia.GetBoolean() : false,
            IsFaceCard = cardElement.TryGetProperty("IsFaceCard", out var ifc) ? ifc.GetBoolean() : false
        };
    }
    
    private async Task StartGame()
    {
        if (userBalance < selectedChip)
        {
            errorMessage = "Insufficient balance";
            return;
        }
        
        try
        {
            isStartingGame = true;
            ClearMessages();
            
            if (!string.IsNullOrEmpty(currentUserId) && int.TryParse(currentUserId, out int userId))
            {
                var response = await BlackjackService.StartNewGameAsync(userId, selectedChip);
                
                if (response.Success)
                {
                    await UpdateGameData(response.Data);
                    await Task.Delay(200);
                    await RefreshUserBalance();
                }
                else
                {
                    errorMessage = response.Message;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in StartGame: {ex.Message}");
            errorMessage = "Error starting game";
        }
        finally
        {
            isStartingGame = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private async Task Hit()
    {
        await ExecuteAction("Hit", async () =>
        {
            var response = await BlackjackService.HitAsync(int.Parse(currentUserId));
            await UpdateGameFromResponse(response);
        });
    }
    
    private async Task Stand()
    {
        await ExecuteAction("Stand", async () =>
        {
            showDealerAnimation = true;
            StateHasChanged();
            
            await Task.Delay(1500);
            
            var response = await BlackjackService.StandAsync(int.Parse(currentUserId));
            await UpdateGameFromResponse(response);
            
            showDealerAnimation = false;
        });
    }
    
    private async Task DoubleDown()
    {
        if (userBalance < currentGameBet)
        {
            errorMessage = "Insufficient balance for Double Down";
            return;
        }
        
        await ExecuteAction("DoubleDown", async () =>
        {
            var response = await BlackjackService.DoubleDownAsync(int.Parse(currentUserId));
            await UpdateGameFromResponse(response);
        });
    }
    
    private async Task Surrender()
    {
        await ExecuteAction("Surrender", async () =>
        {
            var response = await BlackjackService.SurrenderAsync(int.Parse(currentUserId));
            await UpdateGameFromResponse(response);
        });
    }
    
    private async Task ExecuteAction(string actionName, Func<Task> action)
    {
        if (string.IsNullOrEmpty(currentUserId) || !int.TryParse(currentUserId, out _))
            return;
            
        try
        {
            isProcessingAction = true;
            currentAction = actionName;
            ClearMessages();
            
            await action();
            
            await Task.Delay(100);
            await RefreshUserBalance();
            
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in ExecuteAction ({actionName}): {ex.Message}");
            errorMessage = $"Error in {actionName}";
        }
        finally
        {
            isProcessingAction = false;
            currentAction = "";
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private async Task UpdateGameFromResponse(BlackjackGame.GameResponse response)
    {
        if (response.Success && response.Data != null)
        {
            await UpdateGameData(response.Data);
            
            await Task.Delay(100);
            await RefreshUserBalance();
            
            if (currentGameStatus != "Active")
            {
                await Task.Delay(300);
                await RefreshUserBalance();
            }
        }
        else
        {
            errorMessage = response.Message;
        }
    }
    
    private async Task NewGame()
    {
        try
        {
            showResultPopup = false;
            ClearGameState();
            ClearMessages();
            
            await RefreshUserBalance();
            await LoadGameState();
            
            await Task.Delay(50);
            await RefreshUserBalance();
            
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in NewGame: {ex.Message}");
        }
    }
    
    private void ClearGameState()
    {
        hasActiveGame = false;
        currentGameBet = 0;
        currentGameStatus = "";
        playerCards.Clear();
        dealerCards.Clear();
        playerValue = 0;
        dealerValue = 0;
        canDoubleDown = false;
        resultMessage = "";
        resultClass = "";
        winAmount = 0;
    }
    
    private string GetResultMessage(string status)
    {
        return status switch
        {
            "Blackjack" => "BLACKJACK!",
            "PlayerWon" => "YOU WIN!",
            "DealerWon" => "YOU LOSE",
            "Draw" => "PUSH",
            "PlayerBusted" => "BUST!",
            "DealerBusted" => "DEALER BUST!",
            "Surrendered" => "SURRENDERED",
            _ => ""
        };
    }
    
    private string GetResultClass(string status)
    {
        return status switch
        {
            "Blackjack" or "PlayerWon" or "DealerBusted" => "result-win",
            "DealerWon" or "PlayerBusted" => "result-loss",
            "Draw" or "Surrendered" => "result-draw",
            _ => ""
        };
    }
    
    private void SelectChip(double chipValue)
    {
        selectedChip = chipValue;
    }
    
    private void ToggleRules()
    {
        showRules = !showRules;
    }
    
    private void ClearErrorMessage()
    {
        errorMessage = "";
    }
    
    private void ClearMessages()
    {
        errorMessage = "";
        resultMessage = "";
    }
}