@page "/settings"
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using CoinDrop.services.interfaces
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer
@attribute [Authorize]
@inject AuthenticationStateProvider AuthStateProvider
@inject IUserService UserService
@inject NavigationManager Nav

<div class="panel">
    <div class="panel-title">SETTINGS</div>

    @if (!_loaded)
    {
        <div class="loading">Loading settings...</div>
    }
    else if (!_isAuth)
    {
        <div class="auth-error">Not logged in. Please sign in to access settings.</div>
    }
    else
    {
        <div class="settings-grid">
            <!-- PROFILE PICTURE -->
            <div class="card">
                <div class="card-title">Profile Picture</div>

                <div class="pfp-row">
                    <img class="pfp" src="@(_pfpUrl ?? "/images/default-pfp.png")" alt="Profile picture" />

                    <div class="pfp-actions">
                        <div class="file-input-wrapper">
                            <label class="file-label">
                                <InputFile OnChange="OnPfpSelected" accept="image/png,image/jpeg,image/webp" />
                                <span class="file-text">Choose Image</span>
                            </label>
                        </div>
                        <button class="btn-primary" @onclick="UploadPfp" disabled="@(_pfpFile is null || _busy)">
                            Upload
                        </button>

                        <div class="hint">
                            Supported formats: JPG, PNG, WebP (max. 2MB)
                        </div>

                        @if (!string.IsNullOrWhiteSpace(_pfpMsg))
                        {
                            <div class="message @(_pfpMsg.Contains("successfully") ? "success" : "error")">
                                @_pfpMsg
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- EMAIL -->
            <div class="card">
                <div class="card-title">Email Address</div>

                <div class="info-row">
                    <div class="info-label">Current address:</div>
                    <div class="info-value">@_email</div>
                </div>

                <div class="info-row">
                    <div class="info-label">Confirmed:</div>
                    <div class="info-value @(_emailConfirmed ? "confirmed" : "unconfirmed")">
                        @(_emailConfirmed ? "✅ Confirmed" : "❌ Not confirmed")
                    </div>
                </div>

                <div class="divider"></div>

                <div class="section-title">Change Email Address</div>
                <div class="hint">
                    A confirmation email will be sent to the new address.
                </div>

                <div class="row">
                    <input class="input" 
                           placeholder="Enter new email address" 
                           @bind="_newEmail"
                           disabled="@_busy" />
                    <button class="btn-primary" @onclick="RequestEmailChange" disabled="@_busy">
                        Send confirmation link
                    </button>
                </div>

                @if (!string.IsNullOrWhiteSpace(_emailMsg))
                {
                    <div class="message @(_emailMsg.Contains("sent") || _emailMsg.Contains("updated") ? "success" : "error")">
                        @_emailMsg
                    </div>
                }
            </div>

            <!-- USERNAME -->
            <div class="card">
                <div class="card-title">Username</div>

                <div class="info-row">
                    <div class="info-label">Current username:</div>
                    <div class="info-value">@_userName</div>
                </div>

                <div class="divider"></div>

                <div class="section-title">Change Username</div>
                <div class="hint">
                    The new username will take effect immediately.
                </div>

                <div class="row">
                    <input class="input" 
                           placeholder="Enter new username" 
                           @bind="_newUserName"
                           disabled="@_busy" />
                    <button class="btn-primary" @onclick="ChangeUserName" disabled="@_busy">
                        Change
                    </button>
                </div>

                @if (!string.IsNullOrWhiteSpace(_userMsg))
                {
                    <div class="message @(_userMsg.Contains("updated") ? "success" : "error")">
                        @_userMsg
                    </div>
                }
            </div>

            <!-- PASSWORD -->
            <div class="card">
                <div class="card-title">Password</div>

                <div class="section-title">Reset Password</div>
                <div class="hint">
                    A password reset link will be sent to your email address.
                </div>

                <div class="row">
                    <button class="btn-primary" @onclick="SendResetLink" disabled="@_busy">
                        Request reset link
                    </button>
                </div>

                @if (!string.IsNullOrWhiteSpace(_pwdMsg))
                {
                    <div class="message @(_pwdMsg.Contains("sent") ? "success" : "error")">
                        @_pwdMsg
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private bool _loaded;
    private bool _isAuth;
    private bool _busy;

    private string? _pfpUrl;
    private IBrowserFile? _pfpFile;
    private string? _pfpMsg;

    private string? _email;
    private bool _emailConfirmed;
    private string? _newEmail;
    private string? _emailMsg;

    private string? _userName;
    private string? _newUserName;
    private string? _userMsg;

    private string? _pwdMsg;

    protected override async Task OnInitializedAsync()
    {
        // Optional: Message from redirect (confirm-email-change)
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var q = System.Web.HttpUtility.ParseQueryString(uri.Query);
        if (q["msg"] == "email-updated") _emailMsg = "Email was successfully updated.";

        await LoadMe();
        _loaded = true;
    }

    private async Task LoadMe()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var principal = state.User;

        _isAuth = principal?.Identity?.IsAuthenticated == true;
        if (!_isAuth) return;

        var me = await UserService.GetCurrentUserAsync(principal);
        if (me == null) { _isAuth = false; return; }

        _email = me.Email;
        _emailConfirmed = me.EmailConfirmed;

        _userName = me.UserName;
        _pfpUrl = me.ProfileImage;
    }

    private void OnPfpSelected(InputFileChangeEventArgs e)
    {
        _pfpMsg = null;
        _pfpFile = e.File;
        StateHasChanged();
    }

    private async Task UploadPfp()
    {
        if (_pfpFile is null) return;

        _busy = true;
        _pfpMsg = null;
        
        try
        {
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            await using var stream = _pfpFile.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024);

            var res = await UserService.UploadProfileImageAsync(
                state.User,
                stream,
                _pfpFile.ContentType,
                _pfpFile.Size);

            _pfpMsg = res.Succeeded
                ? "Profile picture was successfully updated."
                : string.Join(" | ", res.Errors.Select(e => e.Description));

            await LoadMe();
        }
        catch (Exception ex)
        {
            _pfpMsg = $"Error uploading: {ex.Message}";
        }
        finally
        {
            _busy = false;
            StateHasChanged();
        }
    }

    private async Task RequestEmailChange()
    {
        if (string.IsNullOrWhiteSpace(_newEmail))
        {
            _emailMsg = "Please enter a new email address.";
            StateHasChanged();
            return;
        }

        _busy = true;
        _emailMsg = null;
        
        try
        {
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            var res = await UserService.RequestEmailChangeAsync(state.User, _newEmail.Trim());

            _emailMsg = res.Succeeded
                ? $"Confirmation link was sent to {_newEmail}."
                : string.Join(" | ", res.Errors.Select(e => e.Description));
        }
        finally
        {
            _busy = false;
            StateHasChanged();
        }
    }

    private async Task ChangeUserName()
    {
        if (string.IsNullOrWhiteSpace(_newUserName))
        {
            _userMsg = "Please enter a new username.";
            StateHasChanged();
            return;
        }

        _busy = true;
        _userMsg = null;
        
        try
        {
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            var res = await UserService.RequestUserNameChangeAsync(state.User, _newUserName.Trim());

            _userMsg = res.Succeeded
                ? "Username was successfully updated."
                : string.Join(" | ", res.Errors.Select(e => e.Description));

            await LoadMe();
        }
        finally
        {
            _busy = false;
            StateHasChanged();
        }
    }

    private async Task SendResetLink()
    {
        _busy = true;
        _pwdMsg = null;
        
        try
        {
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            var res = await UserService.SendPasswordResetLinkAsync(state.User);

            _pwdMsg = res.Succeeded
                ? $"A password reset link was sent to {_email}."
                : string.Join(" | ", res.Errors.Select(e => e.Description));
        }
        finally
        {
            _busy = false;
            StateHasChanged();
        }
    }
}