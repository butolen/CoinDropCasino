@page "/deposit-phys"
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@rendermode InteractiveServer

@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject SessionCodeService SessionCodeService

<div class="deposit-page">
    <div class="deposit-card">
        <div class="deposit-title">Deposit</div>

        <div class="deposit-tabs">
            <a class="tab active" href="/deposit-phys">Physical</a>
            <a class="tab" href="/deposit-crypto">Crypto</a>
        </div>

        <input class="deposit-input"
               inputmode="decimal"
               @bind="AmountText"
               placeholder="0.00€" />

        @if (IsSessionVisible)
        {
            <div class="session-code">
                Session-Code: <span>@SessionCode</span>
            </div>

            <button class="btn-secondary" @onclick="OnGenerateNew" disabled="@IsBusy">
                Generate new!
            </button>

            <div class="deposit-hint">
                please reload the site after completing your deposit
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(ErrorMessage))
        {
            <div class="deposit-error">@ErrorMessage</div>
        }

        <div class="deposit-actions">
            <button class="btn-primary" @onclick="OnDeposit" disabled="@IsBusy">
                DEPOSIT
            </button>
            <button class="btn-secondary" @onclick="OnCancel" disabled="@IsBusy">
                CANCEL
            </button>
        </div>
    </div>
</div>

@code {
    private string AmountText = "15.50€";

    private bool IsSessionVisible = false;
    private int SessionCode;
    private bool IsBusy = false;
    private string? ErrorMessage;

    private async Task<int?> GetUserIdAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;

        if (principal?.Identity?.IsAuthenticated != true)
            return null;

        var idText = principal.FindFirstValue(ClaimTypes.NameIdentifier);
        if (int.TryParse(idText, out int userId))
            return userId;

        return null;
    }

    private async Task OnDeposit()
    {
        if (IsBusy) return;
        IsBusy = true;
        ErrorMessage = null;

        try
        {
            int? userId = await GetUserIdAsync();
            if (userId is null)
            {
                Nav.NavigateTo("/login", forceLoad: true);
                return;
            }

            // Session-Code erst beim Deposit erzeugen + speichern
            SessionCode = await SessionCodeService.GenerateAndStoreUniqueCodeAsync(userId.Value);
            IsSessionVisible = true;

            // TODO: hier dein physischer Deposit Flow
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
        finally
        {
            IsBusy = false;
        }
    }

    private async Task OnGenerateNew()
    {
        if (IsBusy) return;
        IsBusy = true;
        ErrorMessage = null;

        try
        {
            int? userId = await GetUserIdAsync();
            if (userId is null) return;

            SessionCode = await SessionCodeService.GenerateAndStoreUniqueCodeAsync(userId.Value);
            IsSessionVisible = true;
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
        finally
        {
            IsBusy = false;
        }
    }

    private void OnCancel()
    {
        Nav.NavigateTo("/", forceLoad: true);
    }
}