@page "/deposit-phys"
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@rendermode InteractiveServer
@attribute [Authorize]
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject SessionCodeService SessionCodeService

<div class="deposit-page">
    <div class="deposit-card">
        <div class="deposit-title">Deposit Physical</div>

        <div class="deposit-tabs">
            <a class="tab active" href="/deposit-phys">Physical</a>
            <a class="tab" href="/deposit-crypto">Crypto</a>
        </div>

        @if (!IsSessionVisible)
        {
            <div class="deposit-instructions">
                <h3 class="instructions-title">How to Deposit</h3>
                <div class="instructions-list">
                    <div class="instruction-item">
                        <span class="instruction-number">1</span>
                        <span class="instruction-text">Click "DEPOSIT" to generate a session code</span>
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">2</span>
                        <span class="instruction-text">Enter the session code into one of our Coin Drop devices</span>
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">3</span>
                        <span class="instruction-text">Insert your cash into the device</span>
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-number">4</span>
                        <span class="instruction-text">Your balance will be updated automatically</span>
                    </div>
                </div>
                
                <div class="warning-box">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <div class="warning-content">
                        <strong>Important Security Notice</strong>
                        <p>If you enter the wrong session code, your funds may be lost. Please verify the code carefully before submitting it on the device.</p>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="session-section">
                <div class="session-header">
                    <h3 class="session-title">Active Session</h3>
                   
                </div>
                
                <div class="session-code-container">
                    <div class="session-code-label">Your Session Code</div>
                    <div class="session-code-display">@SessionCode</div>
                    <div class="session-code-hint">Enter this code on the Coin Drop device</div>
                </div>

                <div class="session-instructions">
                    <p>1. Go to any Coin Drop machine</p>
                    <p>2. Enter the code shown above</p>
                    <p>3. Insert your cash</p>
                </div>

                <button class="btn-generate-new" @onclick="OnGenerateNew" disabled="@IsBusy">
                    üîÑ Generate New Code
                </button>

                <div class="deposit-note">
                    <div class="note-icon">üí°</div>
                    <div class="note-text">Please reload the page after completing your deposit to update your balance.</div>
                </div>
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(ErrorMessage))
        {
            <div class="deposit-error">
                <div class="error-icon">‚ùå</div>
                <div class="error-text">@ErrorMessage</div>
            </div>
        }

       

        <div class="deposit-actions">
            @if (!IsSessionVisible)
            {
                <button class="btn-primary" @onclick="OnDeposit" disabled="@IsBusy">
                    GENERATE DEPOSIT CODE
                </button>
            }
            <button class="btn-secondary" @onclick="OnCancel" disabled="@IsBusy">
                @(IsSessionVisible ? "BACK TO DASHBOARD" : "CANCEL")
            </button>
        </div>
    </div>
</div>

@code {
    private bool IsSessionVisible = false;
    private int SessionCode;
    private bool IsBusy = false;
    private string? ErrorMessage;
    private string? SuccessMessage;
    private DateTime? SessionStartTime;

    protected override async Task OnInitializedAsync()
    {
        // Pr√ºfen, ob bereits ein Session-Code existiert
        var userId = await GetUserIdAsync();
        if (userId.HasValue)
        {
            var existingCode = await SessionCodeService.GetCurrentCodeAsync(userId.Value);
            if (existingCode.HasValue)
            {
                SessionCode = existingCode.Value;
                IsSessionVisible = true;
                SessionStartTime = DateTime.UtcNow;
              
            }
        }
    }

    private async Task<int?> GetUserIdAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;

        if (principal?.Identity?.IsAuthenticated != true)
            return null;

        var idText = principal.FindFirstValue(ClaimTypes.NameIdentifier);
        if (int.TryParse(idText, out int userId))
            return userId;

        return null;
    }

    private async Task OnDeposit()
    {
        if (IsBusy) return;
        IsBusy = true;
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            int? userId = await GetUserIdAsync();
            if (userId is null)
            {
                Nav.NavigateTo("/login", forceLoad: true);
                return;
            }

            // Session-Code generieren mit der urspr√ºnglichen Methode
            SessionCode = await SessionCodeService.GenerateAndStoreUniqueCodeAsync(userId.Value);
            IsSessionVisible = true;
            SessionStartTime = DateTime.UtcNow;
            
            SuccessMessage = "Session code generated successfully!";
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
        finally
        {
            IsBusy = false;
        }
    }

    private async Task OnGenerateNew()
    {
        if (IsBusy) return;
        IsBusy = true;
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            int? userId = await GetUserIdAsync();
            if (userId is null) return;

            // Neuen Code generieren mit der urspr√ºnglichen Methode
            SessionCode = await SessionCodeService.GenerateAndStoreUniqueCodeAsync(userId.Value);
            SessionStartTime = DateTime.UtcNow;
            
            SuccessMessage = "New session code generated! Previous code is now invalid.";
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
        finally
        {
            IsBusy = false;
        }
    }

    private void OnCancel()
    {
        if (IsSessionVisible)
        {
            Nav.NavigateTo("/", forceLoad: true);
        }
        else
        {
            Nav.NavigateTo("/");
        }
    }
}