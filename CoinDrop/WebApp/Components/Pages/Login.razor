@page "/login"
@rendermode InteractiveServer

@using CoinDrop
@using CoinDrop.services.dtos
@using CoinDrop.services.interfaces
@using Microsoft.AspNetCore.Identity
@inject IUserService UserService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager

<EditForm Model="@loginModel" OnValidSubmit="@OnLoginAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="auth-page">
        <div class="auth-card">
            <div class="auth-title">COINDROP</div>

            <div class="auth-tabs">
                <div class="auth-tab auth-tab-active">
                    LOGIN
                </div>
                <div class="auth-tab-divider">|</div>
                <button type="button"
                        class="auth-tab auth-tab-link"
                        @onclick="@(() => NavigationManager.NavigateTo("/register"))">
                    REGISTER
                </button>
            </div>

            <div class="auth-form">
                <div class="auth-field">
                    <label class="auth-label">Username oder Email</label>
                    <InputText class="auth-input"
                               @bind-Value="loginModel.UserNameOrEmail" />
                </div>

                <div class="auth-field">
                    <label class="auth-label">Password</label>
                    <InputText class="auth-input"
                               type="password"
                               @bind-Value="loginModel.Password" />
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="auth-error">@errorMessage</div>
                }

                <div class="auth-buttons">
                    <button type="submit" class="btn-gold-filled">
                        LOGIN
                    </button>
                </div>

                <div class="auth-forgot-password">
                    <a href="#">Passwort vergessen?</a>
                </div>

                <div class="auth-social">
                    <p class="auth-social-text">oder anmelden mit</p>
                    <div class="auth-social-buttons">
                        <button type="button"
                                class="btn-gold-outline"
                                @onclick="@(() => NavigationManager.NavigateTo("/external-login?provider=Google&returnUrl=/"))">
                            GOOGLE
                        </button>
                        <button type="button"
                                class="btn-gold-outline"
                                @onclick="@(() => NavigationManager.NavigateTo("/external-login?provider=Microsoft&returnUrl=/"))">
                            MICROSOFT
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</EditForm>

@code {
    private LoginRequest loginModel = new();
    private string? errorMessage;
    
    protected override void OnInitialized()
    {
        var uri = new Uri(NavigationManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        if (query["e"] == "1")
            errorMessage = "Benutzername/E-Mail oder Passwort ist ungÃ¼ltig.";
        else if (query["e"] == "banned")
            errorMessage = "Dein Konto wurde gesperrt. Bitte kontaktiere den Support.";
        else if (query["msg"] == "banned")
            errorMessage = "Dein Konto wurde gesperrt. Bitte kontaktiere den Support.";
    }
    
    private async Task OnLoginAsync()
    {
        errorMessage = null;

        // 1. Erst User finden
        ApplicationUser? user = await UserManager.FindByNameAsync(loginModel.UserNameOrEmail);
        if (user == null)
        {
            user = await UserManager.FindByEmailAsync(loginModel.UserNameOrEmail);
        }

        if (user == null)
        {
            errorMessage = "Benutzername/E-Mail oder Passwort ist ungÃ¼ltig.";
            return;
        }

        // 2. PrÃ¼fen ob User gebannt ist
        var isLocked = await UserManager.IsLockedOutAsync(user);
        if (isLocked)
        {
            DateTimeOffset? lockoutEnd = await UserManager.GetLockoutEndDateAsync(user);

            if (lockoutEnd.HasValue && lockoutEnd.Value > DateTimeOffset.UtcNow)
            {
                DateTimeOffset end = lockoutEnd.Value;

                // User ist gesperrt
                errorMessage = "ðŸš« Dein Konto wurde gesperrt.";

                if (end < DateTimeOffset.MaxValue)
                {
                    TimeSpan timeLeft = end - DateTimeOffset.UtcNow;

                    if (timeLeft < TimeSpan.FromDays(1))
                    {
                        errorMessage += $" Sperre lÃ¤uft ab in {timeLeft:hh\\:mm\\:ss} Stunden.";
                    }
                    else
                    {
                        errorMessage += $" Sperre lÃ¤uft ab am {end:dd.MM.yyyy HH:mm}.";
                    }
                }
            
                else
                {
                    errorMessage += " Die Sperre ist permanent.";
                }
                errorMessage += " Bitte kontaktiere den Support unter support@coindrop.com.";
                return;
            }
        }

        // 3. Normales Login
        var result = await UserService.LoginAsync(loginModel);

        if (!result.Succeeded)
        {
            errorMessage = "Benutzername/E-Mail oder Passwort ist ungÃ¼ltig.";
            return;
        }

        // 4. Jetzt echter Login via HTTP-Endpoint
        var form = new Dictionary<string, object>
        {
            { "u", loginModel.UserNameOrEmail },
            { "p", loginModel.Password },
            { "rememberMe", "false" }
        };

        await JS.InvokeVoidAsync("postRedirect", "/auth/password-login", form);
    }
}