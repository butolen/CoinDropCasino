@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Domain
@using CoinDrop

@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@inject UserRepo UserRepo

@implements IDisposable
@rendermode InteractiveServer

<nav class="casino-navbar">
    <!-- LEFT: Logo immer -->
    <div class="navbar-left" @onclick="@(() => Nav.NavigateTo("/"))">
        <img src="images/logo.png" alt="Online Casino Logo" class="navbar-logo-img" />
    </div>

    <!-- CENTER: Standard Links immer -->
    <div class="navbar-center">
        <NavLink href="/" class="nav-link" activeClass="nav-link-active">Home</NavLink>
        <NavLink href="/about" class="nav-link" activeClass="nav-link-active">About</NavLink>
        <NavLink href="/roulette" class="nav-link" activeClass="nav-link-active">Roulette</NavLink>
        <NavLink href="/blackjack" class="nav-link" activeClass="nav-link-active">Blackjack</NavLink>

        @if (IsAuthenticated)
        {
            <NavLink href="/history" class="nav-link" activeClass="nav-link-active">History</NavLink>
        }

        @if (IsAdmin)
        {
            <span class="nav-sep">|</span>
            <NavLink href="/admin/dashboard" class="nav-link" activeClass="nav-link-active">Admin</NavLink>
            <NavLink href="/admin/users" class="nav-link" activeClass="nav-link-active">Users</NavLink>
            <NavLink href="/admin/settings" class="nav-link" activeClass="nav-link-active">Settings</NavLink>
        }
    </div>

    <!-- RIGHT: Auth Buttons / User Actions -->
    <div class="navbar-right">
        @if (!IsAuthenticated)
        {
            <button class="btn-nav btn-login" @onclick='() => Nav.NavigateTo("/login")'>LOG IN</button>
            <button class="btn-nav btn-register" @onclick='() => Nav.NavigateTo("/register")'>REGISTER</button>
        }
        else
        {
            <!-- USER INFO CONTAINER -->
            <div class="user-info-container">
                <!-- SETTINGS LINK MIT PROFILBILD -->
                <a href="/settings" class="user-icon-link" title="Settings">
                    <span class="user-icon">
                        @if (user != null && !string.IsNullOrWhiteSpace(user.ProfileImage))
                        {
                            <img src="@user.ProfileImage" alt="User Profile" class="user-circle" />
                        }
                        else
                        {
                            <i class="user-circle"></i>
                        }
                    </span>
                </a>
                
                <!-- USERNAME -->
                <span class="username-display" title="@user?.UserName">
                    @if (user != null && !string.IsNullOrWhiteSpace(user.UserName))
                    {
                        @user.UserName
                    }
                    else
                    {
                        <text>User</text>
                    }
                </span>
            </div>

            <!-- BALANCE -->
            <span class="nav-balance" title="Total Balance">
                @BalanceText
            </span>

            <!-- WITHDRAW -->
            <button class="btn-nav btn-withdraw"
                    @onclick='() => Nav.NavigateTo("/withdraw-crypto")'>
                WITHDRAW
            </button>

            <!-- DEPOSIT -->
            <button class="btn-nav btn-deposit"
                    @onclick='() => Nav.NavigateTo("/deposit-crypto")'>
                DEPOSIT
            </button>

            <!-- LOGOUT -->
            <button class="btn-nav btn-logout" @onclick="Logout">
                LOGOUT
            </button>
        }
    </div>
</nav>

@code {
    private const string RoleCustomer = "customer";
    private const string RoleAdmin = "admin";

    private bool IsAuthenticated;
    private bool IsCustomer;
    private bool IsAdmin;

    private double? TotalBalance; // null = noch nicht geladen
    private string BalanceText => TotalBalance is null ? "—" : $"{TotalBalance.Value:0.00} €";

    // Sicherstellen, dass user geladen wird
    private ApplicationUser user;

    private bool _loadedOnce;

    protected override async Task OnInitializedAsync()
    {
        await UpdateAuthFlagsOnlyAsync();
        if (IsAuthenticated)
        {
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdRaw = state.User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (int.TryParse(userIdRaw, out var userId))
            {
                user = await UserRepo.GetAsync(userId);
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _loadedOnce) return;
        _loadedOnce = true;

        await LoadBalanceIfNeededAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task UpdateAuthFlagsOnlyAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        IsAuthenticated = user.Identity?.IsAuthenticated ?? false;
        IsCustomer = IsAuthenticated && user.IsInRole(RoleCustomer);
        IsAdmin = IsAuthenticated && user.IsInRole(RoleAdmin);

        TotalBalance = null;
    }

    private async Task LoadBalanceIfNeededAsync(CancellationToken ct = default)
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        IsAuthenticated = user.Identity?.IsAuthenticated ?? false;
        IsCustomer = IsAuthenticated && user.IsInRole(RoleCustomer);
        IsAdmin = IsAuthenticated && user.IsInRole(RoleAdmin);

        if (!IsAuthenticated)
        {
            TotalBalance = null;
            return;
        }

        var idRaw = user.FindFirstValue(ClaimTypes.NameIdentifier);
        if (!int.TryParse(idRaw, out var userId))
        {
            TotalBalance = null;
            return;
        }

        var dbUser = await UserRepo.GetAsync(userId, ct);
        TotalBalance = dbUser?.TotalBalance;
    }

    private void Logout()
    {
        Nav.NavigateTo("/logout", forceLoad: true);
    }

    public void Dispose()
    {
        // nix zu tun, kein Event hooked
    }
}

